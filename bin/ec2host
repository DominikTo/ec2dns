#!/usr/bin/php
<?php

/*
 * Find the Composer autoloader.
 * Credit: https://github.com/evert/sabre-vobject/blob/master/bin/vobjectvalidate.php
 */

$paths = array(
    __DIR__ . '/../vendor/autoload.php',  // In case the project is cloned directly
    __DIR__ . '/../../../autoload.php',   // In case the project is a composer dependency.
);

foreach($paths as $path) {
    if (file_exists($path)) {
        include($path);
        break;
    }
}

/*
 * Import namespaces
 */
use \ec2dns\ec2dns\ec2dns;
use \ec2dns\ec2\ec2;

/*
 * Instantiate classes.
 */
$app = new ec2dns();
$app->setCredentials(getenv('AWS_ACCESS_KEY_ID'), getenv('AWS_SECRET_ACCESS_KEY'));

$ec2 = new ec2($app);

/*
 * Set filters.
 * We are only interested in running instances.
 */
$ec2->addFilter('instance-state-name', 'running');

/*
 * Additionally filter by tag, if one was set via the cli parameter.
 */
if(isset($argv[1])) {
    $ec2->addFilter('tag:Name', $argv[1]);
}

/*
 * Get instances and output them.
 */
while ($instance = $ec2->getNext()) {
    if(isset($argv[1])) {
        echo $instance['dnsName']."\n";
    } else {
        echo $instance['instanceId'].": ".$instance['tag']."\t".$instance['dnsName']."\n";
    }
}
